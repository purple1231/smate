<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gemini í…ŒìŠ¤íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/output.css" rel="stylesheet" th:href="@{/css/output.css}">
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg space-y-4">
    <h1 class="text-xl font-bold text-center text-gray-800">Gemini í˜ë¥´ì†Œë‚˜ í…ŒìŠ¤íŠ¸ ğŸ”®</h1>

    <div class="space-y-1">
        <label for="computer-id-input" class="block font-medium text-gray-700">ì»´í“¨í„° ì´ë¦„:</label>
        <input type="text" id="computer-id-input" class="w-full border rounded p-2" placeholder="ì˜ˆ: roy17-desktop" required>
    </div>

    <div class="space-y-1">
        <label for="persona-select" class="block font-medium text-gray-700">ìºë¦­í„° ì„ íƒ:</label>
        <select id="persona-select" class="w-full border rounded p-2 bg-gray-50 focus:ring-2 focus:ring-blue-500">
            <option value="yandere" selected>ì–€ë°ë ˆ (Yandere)</option>
            <option value="mesugaki">ë©”ìŠ¤ê°€í‚¤ (Mesugaki)</option>
            <option value="tsundere">ì¸¤ë°ë ˆ (Tsundere)</option>
        </select>
    </div>

    <form id="chat-form" class="flex gap-2">
        <input type="text" id="chat-input" class="flex-1 border rounded p-2" placeholder="ì§ˆë¬¸ ì…ë ¥..." required>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">ë³´ë‚´ê¸°</button>
    </form>

    <div id="chat-box" class="h-80 overflow-y-auto border rounded p-3 bg-gray-50 space-y-3 text-sm">
    </div>
</div>

<script th:inline="javascript">
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const chatBox = document.getElementById("chat-box");
    const personaSelect = document.getElementById("persona-select");
    const computerIdInput = document.getElementById("computer-id-input"); // âœ¨ ì»´í“¨í„° ID ì…ë ¥ì°½ ê°€ì ¸ì˜¤ê¸°

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userMsg = input.value.trim();
        if (!userMsg) return;

        appendMessage("ë‚˜", userMsg);
        input.value = "";

        const selectedPersona = personaSelect.value;
        const apiUrl = `/gemini/simple?domain=${selectedPersona}`;

        try {
            const res = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "text/plain" }, // ë‹¨ìˆœ í…ìŠ¤íŠ¸ëŠ” text/plainì´ ë” ì •í™•
                body: userMsg
            });

            if (!res.ok) {
                throw new Error(`ì„œë²„ ì—ëŸ¬: ${res.status}`);
            }

            const data = await res.text();
            appendMessage(selectedPersona, data);
        } catch (err) {
            appendMessage("ì‹œìŠ¤í…œ", `(ì—ëŸ¬ ë°œìƒ: ${err.message})`);
        }
    });

    function appendMessage(sender, message, isRecommendation = false, recommendedApp = '') {
        const div = document.createElement("div");
        const senderClass = sender === "ë‚˜" ? "text-right" : "text-left";
        const messageBg = sender === "ë‚˜" ? "bg-blue-100" : (isRecommendation ? "bg-green-100" : "bg-gray-200");

        div.className = `p-2 rounded-lg ${senderClass}`;

        // âœ¨ ì¶”ì²œ ë©”ì‹œì§€ì¼ ê²½ìš° ë²„íŠ¼ ì¶”ê°€
        const actionButton = isRecommendation
            ? `<button onclick="executeApp('${recommendedApp}')" class="mt-2 text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition-colors">âœ… '${recommendedApp}' ë°”ë¡œ ì‹¤í–‰í•˜ê¸°</button>`
            : "";

        div.innerHTML = `
            <div class="font-bold text-xs mb-1">${sender}</div>
            <div class="inline-block p-2 rounded-md ${messageBg}">
                <div class="whitespace-pre-wrap">${message.replace(/"/g, '')}</div>
                ${actionButton}
            </div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // âœ¨ 2. 10ì´ˆë§ˆë‹¤ ì¶”ì²œì„ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    async function checkForRecommendation() {
        const computerId = computerIdInput.value.trim();
        if (!computerId) { // ì»´í“¨í„° IDê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            return;
        }

        try {
            const res = await fetch(`/api/recommendation?computerId=${computerId}`);
            if (res.ok) {
                const data = await res.json();
                const message = `'${data.reasonApp}' ì‚¬ìš© ê¸°ë¡ì„ ë³´ë‹ˆ, '${data.recommendedApp}'ë„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”!`;
                appendMessage("SMATE ì¶”ì²œë´‡", message, true, data.recommendedApp);
            }
            // 404 ì—ëŸ¬ëŠ” ì •ìƒì ì¸ ìƒí™©(ì¶”ì²œ ì—†ìŒ)ì´ë¯€ë¡œ, ì½˜ì†”ì— ì—ëŸ¬ë¥¼ ì°ì§€ ì•ŠìŠµë‹ˆë‹¤.
        } catch (err) {
            console.error("ì¶”ì²œ í™•ì¸ ì¤‘ ì—ëŸ¬:", err);
        }
    }

    // âœ¨ 3. íŒŒì´ì¬(Flask) ì„œë²„ì— ì•± ì‹¤í–‰ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
    async function executeApp(appName) {
        console.log(`'${appName}' ì‹¤í–‰ ìš”ì²­!`);
        try {
            // íŒŒì´ì¬ Flask ì„œë²„ëŠ” ë³´í†µ 5000ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const res = await fetch("http://127.0.0.1:5001/execute", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command: appName })
            });
            if (!res.ok) {
                throw new Error(`ì‹¤í–‰ ì„œë²„ ì—ëŸ¬: ${res.status}`);
            }
            const result = await res.json();
            appendMessage("ì‹œìŠ¤í…œ", result.message);

        } catch (err) {
            appendMessage("ì‹œìŠ¤í…œ", `'${appName}' ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆì–´ìš”. íŒŒì´ì¬ ì‹¤í–‰ ì—ì´ì „íŠ¸ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (ì—ëŸ¬: ${err.message})`);
        }
    }


    // âœ¨ í˜ì´ì§€ ë¡œë“œ í›„ 10ì´ˆë§ˆë‹¤ ì¶”ì²œ í™•ì¸ ì‹œì‘
    setInterval(checkForRecommendation, 10000);
</script>

</body>
</html>