<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gemini í…ŒìŠ¤íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/output.css" rel="stylesheet" th:href="@{/css/output.css}">
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg space-y-4">
    <h1 class="text-xl font-bold text-center text-gray-800">Gemini í˜ë¥´ì†Œë‚˜ í…ŒìŠ¤íŠ¸ ğŸ”®</h1>

    <div class="space-y-1">
        <label for="persona-select" class="block font-medium text-gray-700">ìºë¦­í„° ì„ íƒ:</label>
        <select id="persona-select" class="w-full border rounded p-2 bg-gray-50 focus:ring-2 focus:ring-blue-500">
            <option value="yandere" selected>ì–€ë°ë ˆ (Yandere)</option>
            <option value="mesugaki">ë©”ìŠ¤ê°€í‚¤ (Mesugaki)</option>
            <option value="tsundere">ì¸¤ë°ë ˆ (Tsundere)</option>
        </select>
    </div>

    <form id="chat-form" class="flex gap-2">
        <input type="text" id="chat-input" class="flex-1 border rounded p-2" placeholder="ì§ˆë¬¸ ì…ë ¥..." required>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">ë³´ë‚´ê¸°</button>
    </form>

    <div id="chat-box" class="h-80 overflow-y-auto border rounded p-3 bg-gray-50 space-y-3 text-sm">
    </div>
</div>

<script th:inline="javascript">
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const chatBox = document.getElementById("chat-box");
    // ğŸ‘¨â€ğŸ’» 2. ìƒˆë¡œ ì¶”ê°€í•œ select ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const personaSelect = document.getElementById("persona-select");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userMsg = input.value.trim();
        if (!userMsg) return;

        appendMessage("ë‚˜", userMsg);
        input.value = "";

        // ğŸ‘¨â€ğŸ’» 3. ì„ íƒëœ í˜ë¥´ì†Œë‚˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const selectedPersona = personaSelect.value;
        // ğŸ‘¨â€ğŸ’» 4. API ì£¼ì†Œì— ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°(?domain=ê°’)ë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
        const apiUrl = `/gemini/simple?domain=${selectedPersona}`;


        try {
            // ğŸ‘¨â€ğŸ’» 5. ë™ì ìœ¼ë¡œ ë§Œë“  API ì£¼ì†Œë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
            const res = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" }, // TEXTê°€ ì•„ë‹Œ JSONìœ¼ë¡œ ëª…ì‹œ
                body: userMsg // JSON.stringify()ëŠ” ê°ì²´ë¥¼ ë³´ë‚¼ ë•Œ ì‚¬ìš©, ë‹¨ìˆœ í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ì „ì†¡
            });

            if (!res.ok) { // ì‘ë‹µ ìƒíƒœê°€ 200-299ê°€ ì•„ë‹ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
                throw new Error(`ì„œë²„ ì—ëŸ¬: ${res.status}`);
            }

            const data = await res.text();
            appendMessage(selectedPersona, data); // ë³´ë‚¸ ì‚¬ëŒì„ Gemini ëŒ€ì‹  í˜ë¥´ì†Œë‚˜ ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
        } catch (err) {
            appendMessage("ì‹œìŠ¤í…œ", `(ì—ëŸ¬ ë°œìƒ: ${err.message})`);
        }
    });

    function appendMessage(sender, message) {
        const div = document.createElement("div");
        const senderClass = sender === "ë‚˜" ? "text-right" : "text-left";
        const messageBg = sender === "ë‚˜" ? "bg-blue-100" : "bg-gray-200";

        div.className = `p-2 rounded-lg ${senderClass}`;
        // ğŸ‘¨â€ğŸ’» 6. ì±„íŒ… UIë¥¼ ì¡°ê¸ˆ ë” ë³´ê¸° ì¢‹ê²Œ ê°œì„ 
        div.innerHTML = `
            <div class="font-bold text-xs mb-1">${sender}</div>
            <div class="inline-block p-2 rounded-md ${messageBg}">
                <div class="whitespace-pre-wrap">${message.replace(/"/g, '')}</div>
            </div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>